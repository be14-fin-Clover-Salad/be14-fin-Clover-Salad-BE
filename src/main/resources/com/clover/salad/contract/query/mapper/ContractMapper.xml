<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.clover.salad.contract.query.mapper.ContractMapper">

    <resultMap id="ContractResultMap" type="com.clover.salad.contract.query.dto.ContractDTO">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="createdAt" column="created_at"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="status" column="status"/>
        <result property="amount" column="amount"/>
        <result property="bankName" column="bank_name"/>
        <result property="bankAccount" column="bank_account"/>
        <result property="paymentDay" column="payment_day"/>
        <result property="depositOwner" column="deposit_owner"/>
        <result property="relationship" column="relationship"/>
        <result property="paymentEmail" column="payment_email"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="etc" column="etc"/>
        <result property="employeeName" column="employee_name"/>
        <result property="customerName" column="customer_name"/>
        <result property="productNames" column="product_names"/>
    </resultMap>

    <select id="selectContractInfo" parameterType="int" resultMap="ContractResultMap">
        SELECT
            c.id,
            c.code,
            c.created_at,
            c.start_date,
            c.end_date,
            c.status,
            c.amount,
            c.bank_name,
            c.bank_account,
            c.payment_day,
            c.deposit_owner,
            c.relationship,
            c.payment_email,
            c.is_deleted,
            c.etc,

            e.name AS employee_name,
            cu.name AS customer_name,

            GROUP_CONCAT(p.name SEPARATOR ', ') AS product_names

        FROM contract c
                 JOIN employee e ON c.employee_id = e.id
                 JOIN customer cu ON c.customer_id = cu.id
                 LEFT JOIN contract_product cp ON c.id = cp.contract_id
                 LEFT JOIN product p ON cp.product_id = p.id

        WHERE c.employee_id = #{employeeId}
        GROUP BY c.id
    </select>

</mapper>
